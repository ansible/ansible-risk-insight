---

- name: Test setting user limits in check mode
  block:
    - name: Set user limits in check mode
      rabbitmq_user_limits:
        user: guest
        max_connections: 64
        max_channels: 256
        state: present
      check_mode: true
      register: module_result

    - name: Check that the module's result is correct
      assert:
        that:
          - module_result is changed
          - module_result is success

    - name: Get a list of configured user limits
      shell: "rabbitmqctl list_user_limits"
      register: shell_result

    - name: Check that the check mode does not make any changes
      assert:
        that:
          - shell_result is success
          - "'\"max-connections\":64' not in shell_result.stdout"
          - "'\"max-channels\":256' not in shell_result.stdout"

- name: Test setting user limits
  block:
    - name: Set user limits
      rabbitmq_user_limits:
        user: guest
        max_connections: 64
        max_channels: 256
        state: present
      register: module_result

    - name: Check that the module's result is correct
      assert:
        that:
          - module_result is changed
          - module_result is success

    - name: Get a list of configured user limits
      shell: "rabbitmqctl list_user_limits"
      register: shell_result

    - name: Check that the user limits are actually set
      assert:
        that:
          - shell_result is success
          - "'\"max-connections\":64' in shell_result.stdout"
          - "'\"max-channels\":256' in shell_result.stdout"

- name: Test setting user limits (idempotence)
  block:
    - name: Set user limits (idempotence)
      rabbitmq_user_limits:
        user: guest
        max_connections: 64
        max_channels: 256
        state: present
      register: module_result

    - name: Check the idempotence
      assert:
        that:
          - module_result is not changed
          - module_result is success

- name: Test changing user limits
  block:
    - name: Change user limits
      rabbitmq_user_limits:
        user: guest
        max_connections: 32
        state: present
      register: module_result

    - name: Check that the module's result is correct
      assert:
        that:
          - module_result is changed
          - module_result is success

    - name: Get a list of configured user limits
      shell: "rabbitmqctl list_user_limits"
      register: shell_result

    - name: Check that the user limits are actually set
      assert:
        that:
          - shell_result is success
          - "'\"max-connections\":32' in shell_result.stdout"
          - "'\"max-channels\"' not in shell_result.stdout"

- name: Test clearing user limits in check mode
  block:
    - name: Clear user limits in check mode
      rabbitmq_user_limits:
        user: guest
        state: absent
      check_mode: true
      register: module_result

    - name: Check that the module's result is correct
      assert:
        that:
          - module_result is not changed
          - module_result is success

    - name: Get a list of configured user limits
      shell: "rabbitmqctl list_user_limits"
      register: shell_result

    - name: Check that the check mode does not make any changes
      assert:
        that:
          - shell_result is success
          - "'\"max-connections\":32' in shell_result.stdout"
          - "'\"max-channels\"' not in shell_result.stdout"

- name: Test clearing user limits
  block:
    - name: Clear user limits
      rabbitmq_user_limits:
        user: guest
        state: absent
      register: module_result

    - name: Check that the module's result is correct
      assert:
        that:
          - module_result is changed
          - module_result is success

    - name: Get a list of configured user limits
      shell: "rabbitmqctl list_user_limits"
      register: shell_result

    - name: Check that the user limits are actually cleared
      assert:
        that:
          - shell_result is success
          - "'\"max-connections\":' not in shell_result.stdout"
          - "'\"max-channels\":' not in shell_result.stdout"

- name: Test clearing user limits (idempotence)
  block:
    - name: Clear user limits (idempotence)
      rabbitmq_user_limits:
        user: guest
        state: absent
      register: module_result

    - name: Check the idempotence
      assert:
        that:
          - module_result is not changed
          - module_result is success
