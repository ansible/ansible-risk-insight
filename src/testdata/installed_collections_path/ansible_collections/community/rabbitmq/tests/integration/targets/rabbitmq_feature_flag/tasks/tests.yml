- block:
  - set_fact:
      parameter_name: maintenance_mode_status
      parameter_node: rabbit

  - name: Enable feature flag (check_mode)
    rabbitmq_feature_flag:
      name: "{{ parameter_name }}"
      node: "{{ parameter_node }}"
    register: result_check_mode
    check_mode: yes

  - name: Check if feature_flag module was completed successfully (check_mode)
    assert:
      that:
        - result_check_mode is success

  - name: Enable feature flag
    rabbitmq_feature_flag:
      name: "{{ parameter_name }}"
      node: "{{ parameter_node }}"
    register: result

  - name: Check if feature_flag module was completed successfully
    assert:
      that:
        - result is success

  - name: Ensure that module reported the same 'changed' value with or without check mode
    assert:
      that:
        - result.changed == result_check_mode.changed

  - name: Check if specified feature flag is enabled
    shell: "rabbitmqctl -q list_feature_flags | grep {{ parameter_name }}"
    register: ctl_result

  - name: Idempotent - Enable feature flag (check_mode)
    rabbitmq_feature_flag:
      name: "{{ parameter_name }}"
      node: "{{ parameter_node }}"
    register: result_check_mode
    check_mode: yes

  - name: Idempotent - Check if feature_flag module was completed successfully (check_mode)
    assert:
      that:
        - result_check_mode is success
        - result_check_mode is not changed

  - name: Idempotent - Enable feature flag
    rabbitmq_feature_flag:
      name: "{{ parameter_name }}"
      node: "{{ parameter_node }}"
    register: result

  - name: Idempotent - Check if feature_flag module was completed successfully
    assert:
      that:
        - result is success
        - result is not changed
